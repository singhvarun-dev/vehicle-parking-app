<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>User Dashboard | ParkRight</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
</head>
<body class="container my-4">
<h2>Welcome, {{ user.username }}!</h2>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% for cat, msg in messages %}
    <div class="alert alert-{{ cat }} mt-2">{{ msg }}</div>
  {% endfor %}
{% endwith %}

{% if reservation %}
<div class="card p-3 mb-4">
  <p><strong>Lot:</strong> {{ reservation.spot.lot.name }}</p>
  <p><strong>Spot:</strong> {{ reservation.spot.slot_number }} ({{ reservation.vehicle_type }})</p>
  <p><strong>Start Time:</strong> {{ reservation.start_time.strftime("%Y-%m-%d %H:%M") }}</p>
  <p><strong>Booked Duration:</strong> {{ reservation.duration_hours }} hour(s)</p>
  <a href="{{ url_for('release_spot', res_id=reservation.id) }}" class="btn btn-warning">Release Spot</a>
</div>
{% else %}
<h4>Book a Parking Spot</h4>
<form method="POST" action="{{ url_for('book_spot') }}" class="row g-3 align-items-center mb-4">
  <div class="col-md-4">
    <label for="lotSelect" class="form-label">Choose Lot</label>
    <select name="lot_id" id="lotSelect" class="form-select" required>
      <option value="" selected disabled>Select a lot</option>
      {% for lot in lots %}
      {% set free_spots = lot.spots | selectattr('status', 'equalto', 'Available') | list %}
      <option value="{{ lot.id }}" {% if free_spots|length == 0 %}disabled{% endif %}>
        {{ lot.name }} - ₹{{ "%.2f"|format(lot.price) }}/hr ({{ free_spots|length }} spots free)
      </option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-4">
    <label class="form-label">Vehicle Type</label>
    <select name="vehicle_type" class="form-select" required>
      <option value="4-wheeler">4-Wheeler</option>
      <option value="2-wheeler">2-Wheeler</option>
    </select>
  </div>
  <div class="col-md-2">
    <label class="form-label">Duration (hours)</label>
    <input type="number" name="duration_hours" class="form-control" min="1" max="24" value="1" required />
  </div>
  <div class="col-md-2 d-flex align-items-end">
    <button type="submit" class="btn btn-primary w-100">Book Spot</button>
  </div>
</form>
{% endif %}

<h4>Past Reservations</h4>
<table class="table table-striped table-bordered table-sm">
  <thead>
    <tr>
      <th>Lot</th><th>Spot</th><th>Start</th><th>End</th><th>Cost (₹)</th>
    </tr>
  </thead>
  <tbody>
    {% for r in past_reservations %}
    <tr>
      <td>{{ r.spot.lot.name }}</td>
      <td>{{ r.spot.slot_number }}</td>
      <td>{{ r.start_time.strftime('%Y-%m-%d %H:%M') }}</td>
      <td>{{ r.end_time.strftime('%Y-%m-%d %H:%M') if r.end_time else '-' }}</td>
      <td>{{ '%.2f'|format(r.total_cost) }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<h4>Your Parking Cost History</h4>
<canvas id="userChart" height="120"></canvas>

<script>
fetch("{{ url_for('user_chart_data') }}")
.then(response => response.json())
.then(data => {
  var ctx = document.getElementById('userChart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.labels,
      datasets: [{
        label: 'Cost (₹)',
        data: data.costs,
        fill: false,
        borderColor: 'rgba(75, 192, 192, 1)',
        tension: 0.1
      }]
    },
    options: {
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
});
</script>

<a href="{{ url_for('profile') }}" class="btn btn-secondary me-2 mt-3">Profile</a>
<a href="{{ url_for('logout') }}" class="btn btn-danger mt-3">Logout</a>
</body>
</html>
